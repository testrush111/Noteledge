@model prjMSIT127_G2_Noteledge.ViewModel.CShoppingAccountCenterVM
@using Models.MemberModels
@{
    ViewBag.Title = "_MyProduct";
    CMember member = Session[CMemberSession.Session_Login_User] as CMember;

}

<!--upload file CSS here-->
<link rel="stylesheet" type="text/css" href="~/Content/style.css">


<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="fs-18">
                    我的商品
                    <span class="fs-14">(共計 @Model.lsProductPicture.Count() 項商品)</span>
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item">
                        @Html.ActionLink("筆記商城", "Index", "ShoppingHome")
                    </li>
                    <li class="breadcrumb-item active">賣家中心</li>
                </ol>
            </div>
        </div>
    </div>
</section>
<!-- /.container-fluid -->
<!-- Default box -->
<section class="content">
    <div class="card">
        <div class="card-header">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#modal-lg" id="addnewbtn">
                <i class="fas fa-plus"></i> 新增商品
            </button>
            <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="container-fluid">
                <div class="row">
                    @foreach (var item in Model.lsProductPicture)
                    {
                        <div class="col-md-4">
                            <!-- Widget: user widget style 1 -->
                            <div class="card card-widget widget-user shadow">

                                <div class="widget-user-header bg8">
                                    <div class="">
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn detail_picture" data-toggle="modal" data-target="#exampleModal" data-productid="@item.fProductId">
                                            <img src="@item.fPicture" class="img-fluid" />
                                        </button>
                                    </div>
                                    <div class="text-right">
                                        <button type="button" class="btn btn-sm btn-secondary fs-16" onclick="EditProduct(@item.fProductId)">
                                            <i class="fas fa-eraser"></i> 修改
                                        </button>
                                        <a class="btn btn-sm bg-danger removeit fs-16">
                                            <i class="far fa-trash-alt"> </i> 下架
                                        </a>
                                    </div>
                                </div>
                                <div style="vertical-align:middle" class="m-l-20">
                                    <h5 class="widget-user-username fs-20 p-tb-10">@item.fName</h5>
                                    <h6 class="widget-user-desc m-r-20" style="height:60px;overflow-y: auto;}">@item.fDescription</h6>
                                    @if (Model.lsCategoryCompare.Where(c => c.fProductId == item.fProductId).Count() == 0)
                                    {
                                        <span class="fs-16 float-right badge badge-secondary m-lr-5 m-b-10" style="font-size: 100%;">無</span>
                                    }
                                    @foreach (var category in Model.lsCategoryCompare.Where(c => c.fProductId == item.fProductId))
                                    {
                                        <span class="fs-16 float-right badge badge-info m-lr-5 m-b-10 " style="font-size: 100%;">@category.fCategoryName</span>
                                    }
                                </div>

                                <div class="card-footer">
                                    <div class="row">
                                        <div class="col-sm-4 border-right">
                                            <div class="description-block">
                                                <span class="description-text">售價</span>
                                                <h5 class="description-header fs-18">@item.fPrice.ToString("c0")</h5>
                                            </div>
                                            <!-- /.description-block -->
                                        </div>
                                        <!-- /.col -->
                                        <div class="col-sm-4 border-right">
                                            <div class="description-block">
                                                <span class="description-text">已售出</span>
                                                <h5 class="description-header fs-18">@item.fDownloadTimes</h5>
                                            </div>
                                            <!-- /.description-block -->
                                        </div>
                                        <!-- /.col -->
                                        <div class="col-sm-4">
                                            <div class="description-block">
                                                <span class="description-text">讚數</span>
                                                <h5 class="description-header fs-18">@item.fLikeCount</h5>

                                            </div>
                                            <!-- /.description-block -->
                                        </div>
                                        <!-- /.col -->
                                    </div>
                                    <!-- /.row -->
                                </div>
                            </div>
                            <!-- /.widget-user -->
                        </div>
                    }
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
    <!-- /.card -->
    <!--新增商品畫面-->
    <div class="modal fade p-t-92" id="modal-lg">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h4 class="modal-title">新增筆記商品</h4>
                    <button class="btn btn-default" style="margin-left:450px" onclick="fn填寫商品資訊()">商品資訊Demo</button>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span class="material-icons cl0" aria-hidden="true">
                            clear
                        </span>
                    </button>

                </div>
                <div class="modal-body">
                    <!-- general form elements -->
                    <div class="card card-default">
                        <!-- form start -->
                        @using (Html.BeginForm("CreateProduct", "ShoppingAccountCenter", FormMethod.Post, new { name = "form1" }))
                        {
                            @Html.AntiForgeryToken()
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            <div class="card-body fs-18">
                                <!-- select -->
                                <div class="form-group">
                                    <label>筆記清單:</label>
                                    <input type="text" id="JSONContent" name="Content" style="display:none" />
                                    <input type="text" id="NoteId" name="NoteId" style="display:none"/>
                                    <select name="lsNotefolderVM" class="form-control w-full fs-17" onchange="selectedtext(this)" id="notedropdown">
                                        <option value="" disabled selected>請選擇你的筆記</option>
                                        @foreach (var forder in Model.lsNotefolderVM)
                                        {
                                            <option disabled="disabled" class="bg-gray-light fs-17" name="@forder.fFolderName">@forder.fFolderName</option>
                                            foreach (var note in forder.lsNote)
                                            {

                                                <option data-noteid="@note.fNoteId" value="@note.fJsonContent">@note.fNoteListName</option>
                                            }

                                        }
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        商品名稱:
                                    </label>
                                    <input class="form-control text-box single-line w-full fs-17" placeholder="請輸入..." id="Product_fName" name="Product.fName" type="text" value="" required>
                                    @Html.ValidationMessageFor(model => model.Product.fName, "", new { @class = "text-danger" })
                                </div>
                                <!-- Select multiple-->
                                <div class="form-group">
                                    <label>商品類別:</label>
                                    @*<input class="form-control text-box single-line" id="category">*@
                                    @Html.DropDownList("fCategoryId", (MultiSelectList)ViewBag.Categories, new { @multiple = "multiple", @class = "select2", @id = "DropDown" })
                                </div>
                                <div class="form-group">
                                    <label>
                                        商品描述:
                                    </label>
                                    <textarea class="form-control w-full fs-17" rows="3" placeholder="請輸入..." id="Product_fDescription" name="Product.fDescription" type="text" value="" required></textarea>
                                    @Html.ValidationMessageFor(model => model.Product.fDescription, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group">
                                    <label>
                                        商品價錢(NT$):
                                    </label>
                                    <input class="form-control text-box single-line w-full fs-17" placeholder="請輸入..." id="Product_fPrice" name="Product.fPrice" type="text" value="" required>
                                    @Html.ValidationMessageFor(model => model.Product.fPrice, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group">
                                    <div>
                                        <label>
                                            商品圖片(限5張):
                                        </label>
                                    </div>
                                    <div class="title">
                                        <input class="imageurltxt" name="ProductPicture" type="text" style="display:none">
                                        <img class="myimg" style="width:100px" />
                                        <input class="imageurltxt" name="ProductPicture" type="text" style="display:none">
                                        <img class="myimg" style="width:100px" />
                                        <input class="imageurltxt" name="ProductPicture" type="text" style="display:none">
                                        <img class="myimg" style="width:100px" />
                                        <input class="imageurltxt" name="ProductPicture" type="text" style="display:none">
                                        <img class="myimg" style="width:100px" />
                                        <input class="imageurltxt" name="ProductPicture" type="text" style="display:none">
                                        <img class="myimg" style="width:100px" />
                                    </div>
                                    <div class="dropzone">
                                        <div class="imageinfo">
                                            <p>拖曳或點選封面照片</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-body -->

                            <div class="card-footer justify-content-between">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button id="saveproduct" type="submit" class="btn btn-info float-right" onclick="return false">
                                    儲存並上架
                                </button>
                                <button id="editproduct" type="submit" class="btn btn-info float-right" onclick="return false" style="display:none">
                                    修改
                                </button>
                            </div>
                        }
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
    </div>


    <!-- Modal -->
    <div class="modal fade p-t-92" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-20" id="exampleModalLabel">商品圖片</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="detail_pictureblock">

                    <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators" id="pictureslide">
                        </ol>
                        <div class="carousel-inner" id="insertimg">
                        </div>
                        <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                            <span class="carousel-control-custom-icon" aria-hidden="true">
                                <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                            <span class="carousel-control-custom-icon" aria-hidden="true">
                                <i class="fas fa-chevron-right"></i>
                            </span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="~/Scripts/imgur.js"></script>
<script src="~/Scripts/upload.js"></script>
<script type="text/javascript">
    function selectedtext(item) {
        var selevalue = item.value;
        $("#JSONContent").val(selevalue);
    }

    $(function () {
        //Initialize Select2 Elements
        $(".select2").select2();

        $('.select2').select2({
            placeholder: {
                id: '-1', // the value of the option
                text: '請選擇(可複選)...'
            }
        });
    });


    //修改
    function EditProduct(fProductId) {
        $("form").each(function () {
            this.reset();
        });
        var url = "/ShoppingAccountCenter/EditProduct?fProductId=" + fProductId;
        $(".modal-title").html("修改筆記商品");
        $("#modal-lg").modal();
        $.ajax({
            type: "GET",
            url: url,
            success: function (data) {
                var obj = JSON.parse(data);
                console.log(obj);
                //console.log(obj.lsNotefolderVM);
                $("#JSONContent").val(obj.Product.fContent);
                $("#NoteId").val(obj.NoteId);
                $(`#notedropdown option`).removeAttr("selected");
                $(`#notedropdown option[data-noteid='${obj.NoteId}']`).attr("selected", "selected");
                //$("#notedropdown option:selected").text($(`#notedropdown option[data-noteid='${obj.NoteId}']`).text(););
                $("#Product_fName").val(obj.Product.fName);
                var nowcategory = new Array();
                if (obj.lsCategoryCompare.length == 0) {
                    $("#DropDown").val('-1').trigger('change');
                }
                else {
                    for (var i = 0; i < obj.lsCategoryCompare.length; i++) {
                        nowcategory.push(obj.lsCategoryCompare[i].fCategoryId);
                    }
                    $("#DropDown").val(nowcategory).trigger('change');
                }
                $("#Product_fDescription").val(obj.Product.fDescription);
                $("#Product_fPrice").val(obj.Product.fPrice);

                for (var i = 0; i < obj.lsProductPicture.length; i++) {
                    $(".myimg").eq(i).attr("src", obj.lsProductPicture[i].fPicture);
                    $(".myimg").eq(i).css("height", "80px");
                }

                $("#editproduct").css("display", "block");
                $("#saveproduct").css("display", "none");
            }
        })
    }

</script>

<script type="text/javascript">
    $(document).ready(function () {
        fn商品詳細圖片查詢事件(".detail_picture", "@Url.Action("ProductPicture", "ShoppingAccountCenter")")
        $("#addnewbtn").click(function () {
            $("form").each(function () {
                this.reset();
                $(".modal-title").html("新增筆記商品");
                $("#DropDown").val('-1').trigger('change');
                $(".myimg").removeAttr("src");
                $("#notedropdown option").eq(0).attr("selected", "selected");
            });
        });

        $("#saveproduct").click(function () {
            if ($(".select2-selection__choice").text() == "") {
                const swal = Swal.mixin();
                swal.fire({
                    title: '錯誤',
                    text: "缺少類別資訊",
                    icon: 'error',
                })
            }
            else {
                document.form1.submit();
            }
        });
    });
    function fn商品詳細圖片查詢事件(selector,URL) {
        $(selector).on("click", function () {
            let productid = $(this).data("productid");
            $.ajax({
                type: 'POST',
                url: URL,
                data: { ProductId: productid },
                success: function (msg) {
                    var obj = JSON.parse(msg);
                    //清空內容
                    $("#insertimg").empty();
                    $("#pictureslide").empty();
                    //forEach動態生成標籤
                    obj.forEach((items, index) => {
                        $("#pictureslide").append(`<li data-target="#carouselExampleIndicators" data-slide-to="${index}" class=""></li>`);
                        $("#insertimg").append(`<div class="carousel-item">
                                                <img class= "d-block w-100" src = "${items.fPicture}" alt = "First slide" >
                                                </div >`
                        );

                        $(".carousel-item").first().addClass("active");
                        $(".carousel-indicators li").first().addClass("active");
                    })
                }
            });
        });
    }

    $(function () {
        //刪除單一商品
        $(".removeit").click(function (e) {
            // 停止事件的默認動作,<a>不會再執行「連結到某個網址」這個動作
            e.preventDefault();
            //get a reference to the container form
            const swal = Swal.mixin();
            swal.fire({
                title: '下架',
                text: "確定要將商品下架?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '確認',
                cancelButtonText: '取消',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    swal.fire(
                        '成功下架!',
                        '已將該筆記於商城下架',
                        'success'
                    ).then((result) => {
                        if (result.isConfirmed) {
                            let thisproductid = $(this).parent().prev().children("button").eq(0).data("productid");
                            window.location.href = "/ShoppingAccountCenter/DeleteProduct?fProductId=" + thisproductid;
                        }
                    });
                }
            });
        });
    })

    function fn填寫商品資訊() {
        var ProductName = "JS星星評分功能";
        var Productdescription = "很多網站都有這樣的星星打分效果,簡單教學如何使用javascript實現打分效果，裡面提供詳細程式碼喔~";
        var ProductPrice = "10";
        $("#Product_fName").val(ProductName);
        $("#Product_fDescription").val(Productdescription);
        $("#Product_fPrice").val(ProductPrice);
    }
</script>